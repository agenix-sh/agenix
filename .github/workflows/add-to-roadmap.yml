name: Add Issues to AGeniX Roadmap

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  repository-projects: write   # ← THIS is the correct Projects v2 permission
  contents: read

jobs:
  add_to_project:
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to AGeniX Roadmap project
        uses: actions/github-script@v7
        with:
          script: |
            const org = "agenix-sh";
            const project = "AGeniX Roadmap"; // EXACT match required

            const issueNodeId = context.payload.issue.node_id;

            // Fetch all ProjectsV2 for the organization
            const projects = await github.graphql(`
              query($org: String!) {
                organization(login: $org) {
                  projectsV2(first: 100) {
                    nodes {
                      id
                      title
                    }
                  }
                }
              }
            `, { org });

            const projectNode = projects.organization.projectsV2.nodes
              .find(p => p.title === project);

            if (!projectNode) {
              core.setFailed("Project not found: " + project);
            }

            const projectId = projectNode.id;

            // Add the issue to the org project
            await github.graphql(`
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $projectId,
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }
            `, {
              projectId,
              contentId: issueNodeId
            });

            console.log("✓ Issue added to AGeniX Roadmap");
