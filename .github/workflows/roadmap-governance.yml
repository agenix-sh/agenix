name: AGEniX Roadmap Governance

on:
  issues:
    types: [opened, edited, reopened, closed, assigned]
  pull_request:
    types: [opened, reopened, closed]

permissions:
  contents: read
  issues: write

jobs:
  roadmap-governance:
    runs-on: ubuntu-latest
    steps:
      - name: Add to AGEniX Roadmap
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/agenix-sh/projects/1
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}

      - name: Update Roadmap Fields
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.ORG_PROJECT_TOKEN }}
        with:
          script: |
            const ORG = "agenix-sh";
            const PROJECT_TITLE = "AGeniX Roadmap";
            const COMPONENT_VALUE = "docs";  // repo-specific

            const issueNode =
              context.payload.issue?.node_id ||
              context.payload.pull_request?.node_id;

            if (!issueNode) {
              console.log("No issue/PR node id. Skipping.");
              return;
            }

            // Priority based on labels
            const labels =
              (context.payload.issue?.labels ||
               context.payload.pull_request?.labels || [])
               .map(l => l.name);

            let priority = "P3";
            if (labels.includes("P1")) priority = "P1";
            if (labels.includes("P2")) priority = "P2";

            // Status based on lifecycle
            let status = "Backlog";
            if (context.payload.action === "assigned") status = "Next";
            if (context.payload.pull_request?.state === "open") status = "Doing";
            if (context.payload.issue?.state === "closed" ||
                context.payload.pull_request?.state === "closed")
                status = "Done";

            // --- FETCH PROJECT + FIELDS + ITEMS ---
            const result = await github.graphql(`
              query($org: String!) {
                organization(login: $org) {
                  projectsV2(first: 20) {
                    nodes {
                      id
                      title
                      fields(first: 50) {
                        nodes {
                          __typename
                          id
                          name
                          dataType
                          ... on ProjectV2SingleSelectField {
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                      items(first: 200) {
                        nodes {
                          id
                          content {
                            ... on Issue { id }
                            ... on PullRequest { id }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `, { org: ORG });

            // pick the project
            const project = result.organization.projectsV2.nodes
              .find(p => p.title === PROJECT_TITLE);

            if (!project) {
              console.log("Project not found!");
              return;
            }

            // find the project item by matching content id
            const item = project.items.nodes.find(
              i => i.content?.id === issueNode
            );
            if (!item) {
              console.log("Project item not found yet; add-to-project will handle creation.");
              return;
            }

            // helper to find field and correct option
            function getField(name) {
              return project.fields.nodes.find(f => f.name === name);
            }
            function getOption(field, valueName) {
              return field.options?.find(o => o.name === valueName);
            }

            async function setFieldValue(fieldName, valueName) {
              const field = getField(fieldName);
              if (!field) return;

              if (field.__typename !== "ProjectV2SingleSelectField") {
                console.log(`Field '${fieldName}' is not single-select.`);
                return;
              }

              const option = getOption(field, valueName);
              if (!option) {
                console.log(`Option '${valueName}' not found for field '${fieldName}'`);
                return;
              }

              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input:{
                    projectId:$projectId,
                    itemId:$itemId,
                    fieldId:$fieldId,
                    value:{ singleSelectOptionId:$optionId }
                  }) {
                    projectV2Item { id }
                  }
                }
              `, {
                projectId: project.id,
                itemId: item.id,
                fieldId: field.id,
                optionId: option.id
              });

              console.log(`✓ Updated ${fieldName} → ${valueName}`);
            }

            await setFieldValue("Component", COMPONENT_VALUE);
            await setFieldValue("Priority", priority);
            await setFieldValue("Status", status);

            console.log("✓ All fields updated");
