name: AGEniX Roadmap Governance

on:
  issues:
    types: [opened, edited, reopened, closed, assigned]
  pull_request:
    types: [opened, reopened, closed]

permissions:
  contents: read
  issues: write

jobs:
  roadmap-governance:
    runs-on: ubuntu-latest

    steps:
      - name: Add to AGEniX Roadmap
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/agenix-sh/projects/1
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}

      - name: Update roadmap fields using REST API
        env:
          GH_TOKEN: ${{ secrets.ORG_PROJECT_TOKEN }}
        run: |
          # -----------------------------------------------
          # CONFIG
          # -----------------------------------------------
          PROJECT_ID=$(gh api graphql -f query='
            query {
              organization(login:"agenix-sh") {
                projectsV2(first:20) {
                  nodes { id title }
                }
              }
            }' \
            --jq '.data.organization.projectsV2.nodes[] | select(.title=="AGeniX Roadmap") | .id')

          echo "Project ID: $PROJECT_ID"

          # Content node id (issue or PR)
          CONTENT_ID=$(jq -r '.issue.node_id // .pull_request.node_id' <<< "$GITHUB_EVENT_PATH")
          if [ "$CONTENT_ID" = "null" ]; then
            echo "No content node id found. Exiting."
            exit 0
          fi

          # -----------------------------------------------
          # Get project fields via REST (stablest path)
          # -----------------------------------------------
          FIELDS_JSON=$(gh api \
            /projects/${PROJECT_ID}/fields \
            -H "Accept: application/vnd.github+json")

          # Field IDs
          COMPONENT_FIELD=$(echo "$FIELDS_JSON" | jq -r '.[] | select(.name=="Component") | .id')
          PRIORITY_FIELD=$(echo "$FIELDS_JSON" | jq -r '.[] | select(.name=="Priority") | .id')
          STATUS_FIELD=$(echo "$FIELDS_JSON" | jq -r '.[] | select(.name=="Status") | .id')

          echo "Field IDs:"
          echo "Component = $COMPONENT_FIELD"
          echo "Priority  = $PRIORITY_FIELD"
          echo "Status    = $STATUS_FIELD"

          # -----------------------------------------------
          # Find the project item id matching our content
          # -----------------------------------------------
          ITEM_ID=$(gh api \
            /projects/${PROJECT_ID}/items \
            -H "Accept: application/vnd.github+json" \
            --jq ".items[] | select(.content_node_id==\"$CONTENT_ID\") | .id")

          if [ -z "$ITEM_ID" ]; then
            echo "Item not found yet. Workflow will run again. Exiting."
            exit 0
          fi

          echo "Item ID: $ITEM_ID"

          # -----------------------------------------------
          # Determine field values
          # -----------------------------------------------
          COMPONENT="docs"

          # Priority based on labels
          PRIORITY="P3"
          if gh api "$GITHUB_EVENT_PATH" | jq -e '.issue.labels[] | select(.name=="P1")' >/dev/null 2>&1; then PRIORITY="P1"; fi
          if gh api "$GITHUB_EVENT_PATH" | jq -e '.issue.labels[] | select(.name=="P2")' >/dev/null 2>&1; then PRIORITY="P2"; fi

          # Status based on state
          STATUS="Backlog"
          if [ "${GITHUB_EVENT_NAME}" = "issues" ] && [ "${GITHUB_EVENT_ACTION}" = "assigned" ]; then STATUS="Next"; fi
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ] && [ "${GITHUB_EVENT_ACTION}" = "opened" ]; then STATUS="Doing"; fi
          if [ "${GITHUB_EVENT_ACTION}" = "closed" ]; then STATUS="Done"; fi

          echo "Setting:"
          echo "  Component = $COMPONENT"
          echo "  Priority  = $PRIORITY"
          echo "  Status    = $STATUS"

          # -----------------------------------------------
          # Helper: Resolve field option IDs
          # -----------------------------------------------
          get_option_id () {
            field_id=$1
            value=$2
            echo "$FIELDS_JSON" | jq -r \
              ".[] | select(.id==\"$field_id\") | .options[] | select(.name==\"$value\") | .id"
          }

          COMPONENT_ID=$(get_option_id "$COMPONENT_FIELD" "$COMPONENT")
          PRIORITY_ID=$(get_option_id "$PRIORITY_FIELD" "$PRIORITY")
          STATUS_ID=$(get_option_id "$STATUS_FIELD" "$STATUS")

          # -----------------------------------------------
          # Update fields (REST)
          # -----------------------------------------------
          gh api \
            /projects/${PROJECT_ID}/items/${ITEM_ID}/fields/${COMPONENT_FIELD} \
            -X PUT -F "value=$COMPONENT_ID" \
            -H "Accept: application/vnd.github+json"

          gh api \
            /projects/${PROJECT_ID}/items/${ITEM_ID}/fields/${PRIORITY_FIELD} \
            -X PUT -F "value=$PRIORITY_ID" \
            -H "Accept: application/vnd.github+json"

          gh api \
            /projects/${PROJECT_ID}/items/${ITEM_ID}/fields/${STATUS_FIELD} \
            -X PUT -F "value=$STATUS_ID" \
            -H "Accept: application/vnd.github+json"

          echo "âœ“ Fields updated via REST"
